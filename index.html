<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–¥–∏–Ω—ã–π –ß–∞—Ç</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <style>
        :root {
            --primary-color: #74a4bc; /* –ì–æ–ª—É–±–æ–π –ê–π—Å–±–µ—Ä–≥ */
            --dark-bg: #2b323c;
            --light-bg: #3a4756;
            --text-color: #eaf2f8;
            --sent-message-bg: #007acc;
            --admin-color: gold;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #232a34, #1c2530, #2b323c);
            background-size: 200% 200%;
            color: var(--text-color);
            overflow: hidden;
            animation: gradient-flow 15s ease infinite;
        }

        @keyframes gradient-flow { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 20px; }

        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 3000; transition: opacity .5s ease,visibility .5s }
        #loading-screen.hidden { opacity: 0; visibility: hidden }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,.2); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite }
        @keyframes spin { to { transform: rotate(360deg) } }
        .loading-text { margin-top: 20px; font-size: 1.1em; color: var(--text-color) }
        
        #auth-container { display: none; justify-content: center; align-items: center; height: 100vh }
        .auth-form-wrapper { width: 340px; height: 500px; background: rgba(58, 71, 86, 0.7); border-radius: 15px; backdrop-filter: blur(12px); box-shadow: 0 10px 40px rgba(0,0,0,.4); overflow: hidden; position: relative }
        #form-slider { display: flex; width: 200%; height: 100%; transition: transform .7s cubic-bezier(.68,-.55,.27,1.55) }
        #form-slider.show-register { transform: translateX(-50%) }
        .auth-form { width: 50%; padding: 40px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; text-align: center }
        .auth-form h2 { margin-bottom: 25px; font-weight: 600 }
        .auth-form input { width: 100%; padding: 14px; margin-bottom: 18px; border: 1px solid transparent; border-radius: 8px; background: var(--dark-bg); color: var(--text-color); box-sizing: border-box; transition: all .3s ease }
        .auth-form input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 15px rgba(116, 164, 188, 0.5) }
        .auth-form button { width: 100%; padding: 14px; border: none; border-radius: 8px; background: var(--primary-color); color: #fff; cursor: pointer; font-size: 16px; font-weight: 600; transition: all .3s ease }
        .auth-form button:hover { transform: translateY(-3px); filter: brightness(1.1); box-shadow: 0 5px 15px rgba(116, 164, 188, 0.4) }
        .toggle-form { margin-top: 20px; font-size: 14px; cursor: pointer; color: var(--primary-color); font-weight: 500 }
        .auth-error-message { color: #e74c3c; margin-top: 15px; min-height: 20px; font-size: 14px }
        
        #chat-container { display: none; flex-direction: column; height: 100vh; max-width: 800px; margin: 0 auto; background: rgba(43, 50, 60, 0.5); backdrop-filter: blur(10px); border-radius: 5px }
        #chat-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(35, 42, 52, 0.7); border-bottom: 1px solid rgba(255,255,255,.1) }
        #header-left { display: flex; align-items: center; gap: 15px }
        #user-info { font-size: 14px; font-weight: 700 }
        #settings-btn { background: none; border: none; color: #bdc3c7; cursor: pointer; font-size: 20px; transition: color .2s, transform 0.4s ease; }
        #settings-btn:hover { color: #fff; transform: rotate(90deg); }
        
        #chat-window { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column }
        .message-wrapper { display: flex; flex-direction: column; margin-bottom: 15px; max-width: 75%; position: relative; }
        .sender-nickname { font-size: 14px; color: #bdc3c7; margin-bottom: 5px; font-weight: 700 }
        .message-wrapper.sent .sender-nickname { margin-right: 10px }
        .message-wrapper.received .sender-nickname { margin-left: 10px }
        .message { padding: 12px 18px; border-radius: 20px; line-height: 1.4; animation: fadeIn .5s forwards; word-wrap: break-word }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .message-wrapper.sent { align-self: flex-end; align-items: flex-end }
        .message-wrapper.received { align-self: flex-start; align-items: flex-start }
        .message.received { background: var(--light-bg); border-bottom-left-radius: 5px }
        .message.sent { background: var(--sent-message-bg); color: #fff; border-bottom-right-radius: 5px }
        
        .delete-btn { position: absolute; top: 50%; left: -40px; transform: translateY(-50%); background: transparent; border: none; color: #7f8c8d; width: 24px; height: 24px; font-size: 20px; cursor: pointer; opacity: 0; transition: all .2s; }
        .message-wrapper.sent:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: #e74c3c; }
        
        .falling-letter { display: inline-block; position: fixed; opacity: 1; animation: fallAndFade 2.5s cubic-bezier(.4,0,1,1) forwards; pointer-events: none; white-space: pre; z-index: -1 }
        @keyframes fallAndFade { 0%{transform:translateY(0) rotate(0)} 100%{transform:translateY(150vh) rotate(360deg);opacity:0} }
        
        #message-form { display: flex; padding: 20px; background: rgba(35, 42, 52, 0.7) }
        #message-input { flex-grow: 1; border: none; padding: 15px; border-radius: 25px; background: var(--dark-bg); color: var(--text-color); font-size: 16px; transition: all .3s ease; }
        #message-input:focus { outline: none; box-shadow: 0 0 0 2px var(--primary-color) }
        #send-button { width: 50px; height: 50px; margin-left: 15px; border: none; background: var(--primary-color); color: #fff; border-radius: 50%; cursor: pointer; font-size: 20px; transition: all .2s; }
        #send-button:hover { background-color: #8db5ca; transform: scale(1.1) }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transition: opacity .4s ease,visibility .4s }
        .modal.open { opacity: 1; visibility: visible }
        .modal-content { background: var(--light-bg); padding: 30px 40px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,.5); position: relative; transform: scale(.9); transition: transform .4s cubic-bezier(.175,.885,.32,1.275) }
        .modal.open .modal-content { transform: scale(1) }
        .modal-content h2 { margin-top: 0; margin-bottom: 20px }
        .modal-content input { width: 100%; padding: 12px; margin: 15px 0; box-sizing: border-box; background: var(--dark-bg); color: var(--text-color); border: 1px solid transparent; border-radius: 8px; transition: all .3s ease }
        .modal-content input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 15px rgba(116, 164, 188, 0.5) }
        .modal-content button { background: var(--primary-color); border: none; color: #fff; padding: 12px 20px; margin-top: 10px; border-radius: 8px; cursor: pointer; transition: all .3s ease }
        .modal-content button:hover { transform: translateY(-2px); filter: brightness(1.1) }
        .modal-close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #7f8c8d; font-size: 28px; cursor: pointer; transition: all .2s }
        .modal-close-btn:hover { color: #fff; transform: rotate(90deg) }
        #admin-panel-btn { background-color: var(--admin-color); display: none; /* –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */ }
        #logout-btn { background-color: #c0392b }
        #admin-modal .toggle { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 }

        #mod-menu { position: absolute; background: var(--dark-bg); border: 1px solid var(--light-bg); border-radius: 8px; padding: 10px; z-index: 100; display: none; flex-direction: column; gap: 5px; }
        .mod-menu-btn { background: var(--light-bg); border: none; color: var(--text-color); padding: 8px; border-radius: 5px; cursor: pointer; }
        .mod-menu-btn.danger { background: #c0392b }
        .mod-menu-input { padding: 5px; border-radius: 5px; border: none; background: #2b323c; color: #fff; }
        
        .rainbow-text {
            background-image: linear-gradient(90deg, #ff7f00, #ff0, #0f0, #0ff, #00f, #8b00ff, #ff7f00);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: rainbow-anim 4s linear infinite;
        }
        @keyframes rainbow-anim {
            from { background-position: 0% 50%; }
            to { background-position: 200% 50%; }
        }

        .break-site-anim{animation:chaos 1.5s linear infinite alternate}
        @keyframes chaos{0%{transform:translate(0,0) rotate(0) scale(1);filter:hue-rotate(0) invert(0)}25%{transform:translate(20px,-20px) rotate(15deg) scale(1.1);filter:hue-rotate(90deg) invert(.2)}50%{transform:translate(-20px,20px) rotate(-15deg) scale(.9);filter:hue-rotate(180deg) invert(.5)}100%{transform:translate(10px,-10px) rotate(360deg) scale(1.2);filter:hue-rotate(360deg) invert(1)}}
    </style>
</head>
<body>

    <div id="loading-screen"><div class="spinner"></div><p class="loading-text" id="loading-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</p></div>
    <div id="auth-container"><div class="auth-form-wrapper"><div id="form-slider"><div id="login-form" class="auth-form"><h2>–í—Ö–æ–¥ –≤ –ß–∞—Ç</h2><input type="email" id="login-email" placeholder="Email" required><input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" required><button id="login-btn">–í–æ–π—Ç–∏</button><p id="auth-error-login" class="auth-error-message"></p><p class="toggle-form" onclick="toggleAuthForms()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</p></div><div id="register-form" class="auth-form"><h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2><input type="text" id="register-nickname" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" required><input type="email" id="register-email" placeholder="Email" required><input type="password" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å" required><button id="register-btn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button><p id="auth-error-register" class="auth-error-message"></p><p class="toggle-form" onclick="toggleAuthForms()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</p></div></div></div></div>
    
    <div id="chat-container">
        <div id="chat-header">
            <div id="header-left">
                <span id="user-info"></span>
                <button id="settings-btn">‚öôÔ∏è</button>
            </div>
        </div>
        <div id="chat-window"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" required>
            <button type="submit" id="send-button">‚û§</button>
        </form>
    </div>
    
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <button id="close-settings-modal-btn" class="modal-close-btn">&times;</button>
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <input type="text" id="new-nickname-input" placeholder="–ù–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º">
            <button id="save-nickname-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="admin-panel-btn">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</button>
            <button id="logout-btn">–í—ã–π—Ç–∏</button>
        </div>
    </div>
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <button id="close-admin-modal-btn" class="modal-close-btn">&times;</button>
            <h2>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
            <div class="toggle">
                <label for="rainbow-nick-toggle">–†–∞–¥—É–∂–Ω—ã–π –Ω–∏–∫</label>
                <input type="checkbox" id="rainbow-nick-toggle">
            </div>
            <div class="toggle">
                <label for="rainbow-msg-toggle">–†–∞–¥—É–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                <input type="checkbox" id="rainbow-msg-toggle">
            </div>
        </div>
    </div>
    <div id="mod-menu"></div>

    <script>
        // --- –ù–ê–°–¢–†–û–ô–ö–ò –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ---
        const ADMIN_PASSWORD = "111";

        const firebaseConfig = {
            apiKey: "AIzaSyBTcH3_tri2L7AHLh1e-YD-0s-QSthuE6Q",
            authDomain: "disk-c98ee.firebaseapp.com",
            projectId: "disk-c98ee",
            storageBucket: "disk-c98ee.appspot.com",
            messagingSenderId: "59577059636",
            appId: "1:59577059636:web:e98f456d054cc360747d61",
            databaseURL: "https://disk-c98ee-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const messagesRef = database.ref('messages');
        const usersRef = database.ref('users');
        const commandsRef = database.ref('commands');
        const adminRef = database.ref('admin');

        const loadingScreen = document.getElementById('loading-screen');
        const authContainer = document.getElementById('auth-container');
        const chatContainer = document.getElementById('chat-container');
        const chatWindow = document.getElementById('chat-window');
        const settingsModal = document.getElementById('settings-modal');
        const adminModal = document.getElementById('admin-modal');
        const modMenu = document.getElementById('mod-menu');
        let currentUserIsAdmin = false;
        let isSiteBrokenForMe = false;

        database.ref('.info/connected').on('value', snap => {
            if (snap.val() === true) {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        initializeChat(user);
                    } else {
                        loadingScreen.classList.add('hidden');
                        setTimeout(() => authContainer.style.display = 'flex', 500);
                    }
                });
            } else {
                loadingScreen.querySelector('.loading-text').textContent = "–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...";
            }
        });

        async function initializeChat(user) {
            loadingScreen.querySelector('.loading-text').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
            loadingScreen.classList.remove('hidden');
            authContainer.style.display = 'none';

            const userStatusSnap = await usersRef.child(user.uid).child('status').get();
            const userStatus = userStatusSnap.val() || {};
            if (userStatus.isBanned && userStatus.banExpires > Date.now()) {
                alert(`–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –¥–æ ${new Date(userStatus.banExpires).toLocaleString()}`);
                auth.signOut();
                return;
            }
            
            const adminSnap = await adminRef.get();
            if (adminSnap.exists() && adminSnap.val().uid === user.uid) {
                currentUserIsAdmin = true;
                localStorage.setItem('isAdminVerified', 'true');
                document.getElementById('admin-panel-btn').style.display = 'block';
            }

            const snapshot = await usersRef.child(user.uid).get();
            const userData = snapshot.val();
            const displayName = userData?.nickname || "–ë–µ–∑—ã–º—è–Ω–Ω—ã–π";
            document.getElementById('user-info').textContent = displayName;
            
            messagesRef.once('value', initialSnapshot => {
                chatWindow.innerHTML = '';
                initialSnapshot.forEach(childSnapshot => {
                    displayMessage(childSnapshot.val(), childSnapshot.key);
                });
                loadingScreen.classList.add('hidden');
                setTimeout(() => chatContainer.style.display = 'flex', 500);
                listenForNewMessages();
            });

            commandsRef.child(user.uid).on('child_added', cmdSnapshot => {
                const cmd = cmdSnapshot.val();
                if (cmd.command === 'break_site') {
                    isSiteBrokenForMe = true;
                    cmdSnapshot.ref.remove();
                }
            });
        }

        function listenForNewMessages() {
            messagesRef.off();
            messagesRef.limitToLast(1).on('child_added', snapshot => {
                if (!document.querySelector(`[data-message-id="${snapshot.key}"]`)) {
                    displayMessage(snapshot.val(), snapshot.key);
                }
            });
            messagesRef.on('child_removed', snapshot => {
                const el = document.querySelector(`[data-message-id="${snapshot.key}"]`);
                if (el) el.remove();
            });
            messagesRef.on('child_changed', async snapshot => {
                const message = snapshot.val();
                const wrapper = document.querySelector(`[data-message-id="${snapshot.key}"]`);
                if (wrapper) {
                    const nickEl = wrapper.querySelector('.sender-nickname');
                    if (nickEl) nickEl.textContent = message.senderNickname;
                }
            });
        }
        
        const messageForm = document.getElementById('message-form');
        messageForm.addEventListener('submit', async e => {
            e.preventDefault();
            if (isSiteBrokenForMe) {
                alert(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–ª—É—á–∞–π–Ω–∞—è –æ—à–∏–±–∫–∞: ${Math.floor(Math.random() * 9000) + 1000}`);
                return;
            }
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();
            const user = auth.currentUser;
            if (messageText && user) {
                const userStatusSnap = await usersRef.child(user.uid).child('status').get();
                const userStatus = userStatusSnap.val() || {};
                if (userStatus.isMuted && userStatus.muteExpires > Date.now()) {
                    return alert(`–£ –≤–∞—Å –º—É—Ç –¥–æ ${new Date(userStatus.muteExpires).toLocaleString()}`);
                }
                const userDataSnap = await usersRef.child(user.uid).get();
                const userData = userDataSnap.val() || {};
                const senderNickname = userData.nickname || '';
                messagesRef.push({
                    text: messageText,
                    senderId: user.uid,
                    senderNickname,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                messageInput.value = '';
            }
        });

        async function displayMessage(message, messageId) {
            const user = auth.currentUser;
            if (!user) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper';
            wrapper.dataset.messageId = messageId;
            wrapper.dataset.senderId = message.senderId;

            const effectsSnap = await usersRef.child(message.senderId).child('effects').get();
            const effects = effectsSnap.val() || {};

            if (message.senderNickname) {
                const sender = document.createElement('div');
                sender.className = 'sender-nickname';
                sender.textContent = message.senderNickname;
                if (effects.rainbowNick) {
                    sender.classList.add('rainbow-text');
                }
                wrapper.appendChild(sender);
            }

            const msgElement = document.createElement('div');
            msgElement.className = 'message';
            if (effects.rainbowMsg) {
                msgElement.classList.add('rainbow-text');
            }
            msgElement.textContent = message.text;

            if (user.uid === message.senderId) {
                wrapper.classList.add('sent');
                msgElement.classList.add('sent');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '√ó';
                deleteBtn.onclick = () => deleteMessage(wrapper, messageId);
                wrapper.appendChild(deleteBtn);
            } else {
                wrapper.classList.add('received');
                msgElement.classList.add('received');
                if (currentUserIsAdmin) {
                    wrapper.addEventListener('dblclick', e => showModMenu(e, message, messageId));
                }
            }
            wrapper.appendChild(msgElement);
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showModMenu(event, message, messageId) {
            event.preventDefault();
            event.stopPropagation();
            modMenu.style.display = 'flex';
            const rect = event.target.getBoundingClientRect();
            modMenu.style.top = `${window.scrollY + rect.bottom + 5}px`;
            modMenu.style.left = `${window.scrollX + rect.left}px`;
            modMenu.innerHTML = '';
            const input = document.createElement('input');
            input.type = 'number';
            input.placeholder = '–ú–∏–Ω—É—Ç—ã';
            input.className = 'mod-menu-input';
            const actions = [
                { text: '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', className: 'danger', action: () => messagesRef.child(messageId).remove() },
                { text: '–ú—É—Ç', action: () => { const time = parseInt(input.value); if (time > 0) usersRef.child(message.senderId).child('status').update({ isMuted: true, muteExpires: Date.now() + time * 60000 }); } },
                { text: '–°–Ω—è—Ç—å –º—É—Ç', action: () => usersRef.child(message.senderId).child('status').update({ isMuted: false }) },
                { text: '–ë–∞–Ω', className: 'danger', action: () => { const time = parseInt(input.value); if (time > 0) usersRef.child(message.senderId).child('status').update({ isBanned: true, banExpires: Date.now() + time * 60000 }); } },
                { text: '–°–Ω—è—Ç—å –±–∞–Ω', action: () => usersRef.child(message.senderId).child('status').update({ isBanned: false }) },
                { text: 'üòà –°–ª–æ–º–∞—Ç—å —Å–∞–π—Ç', className: 'danger', action: () => commandsRef.child(message.senderId).push({ command: 'break_site' }) }
            ];
            modMenu.appendChild(input);
            actions.forEach(item => {
                const btn = document.createElement('button');
                btn.textContent = item.text;
                btn.className = `mod-menu-btn ${item.className || ''}`;
                btn.onclick = (e) => { e.stopPropagation(); item.action(); modMenu.style.display = 'none'; };
                modMenu.appendChild(btn);
            });
        }
        document.body.addEventListener('click', () => { if (modMenu.style.display === 'flex') modMenu.style.display = 'none'; });

        function deleteMessage(wrapper, messageId) {
            const rect = wrapper.getBoundingClientRect();
            const text = wrapper.querySelector('.message')?.textContent || '';
            wrapper.remove();
            for(let i=0; i<text.length; i++){
                const letter = document.createElement('span');
                letter.className = 'falling-letter';
                letter.textContent = text[i];
                letter.style.top = `${rect.top + rect.height / 2}px`;
                letter.style.left = `${rect.left + (i * (rect.width / text.length))}px`;
                letter.style.color = '#fff';
                letter.style.animationDelay = `${Math.random() * 0.3}s`;
                document.body.appendChild(letter);
                setTimeout(() => letter.remove(), 2500);
            }
            messagesRef.child(messageId).remove();
        }

        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.classList.add('open'));
        document.getElementById('close-settings-modal-btn').addEventListener('click', () => settingsModal.classList.remove('open'));
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut().then(() => {
                localStorage.removeItem('isAdminVerified');
                location.reload();
            });
        });
        document.getElementById('admin-panel-btn').addEventListener('click', async () => {
            if (localStorage.getItem('isAdminVerified') === 'true') {
                adminModal.classList.add('open');
                return;
            }
            const pass = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:');
            if (pass === ADMIN_PASSWORD) {
                const adminSnap = await adminRef.get();
                const user = auth.currentUser;
                if (!adminSnap.exists() && user) {
                    await adminRef.set({ uid: user.uid });
                    currentUserIsAdmin = true;
                    alert('–í—ã —É—Å–ø–µ—à–Ω–æ —Å—Ç–∞–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!');
                }
                localStorage.setItem('isAdminVerified', 'true');
                document.getElementById('admin-panel-btn').style.display = 'block';
                adminModal.classList.add('open');
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
            }
        });
        document.getElementById('close-admin-modal-btn').addEventListener('click', () => adminModal.classList.remove('open'));
        
        const rainbowNickToggle = document.getElementById('rainbow-nick-toggle');
        const rainbowMsgToggle = document.getElementById('rainbow-msg-toggle');
        
        auth.onAuthStateChanged(user => {
            if (user && currentUserIsAdmin) {
                usersRef.child(user.uid).child('effects').on('value', snap => {
                    const effects = snap.val() || {};
                    rainbowNickToggle.checked = effects.rainbowNick === true;
                    rainbowMsgToggle.checked = effects.rainbowMsg === true;
                });
            }
        });
        
        const updateAdminEffects = (key, value) => {
            const user = auth.currentUser;
            if (user && currentUserIsAdmin) {
                usersRef.child(user.uid).child('effects').update({ [key]: value }).then(() => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                    document.querySelectorAll(`[data-sender-id="${user.uid}"]`).forEach(wrapper => {
                        const elToUpdate = key === 'rainbowNick' ? wrapper.querySelector('.sender-nickname') : wrapper.querySelector('.message');
                        if (elToUpdate) {
                            elToUpdate.classList.toggle('rainbow-text', value);
                        }
                    });
                });
            }
        };
        rainbowNickToggle.addEventListener('change', (e) => updateAdminEffects('rainbowNick', e.target.checked));
        rainbowMsgToggle.addEventListener('change', (e) => updateAdminEffects('rainbowMsg', e.target.checked));

        const formSlider = document.getElementById('form-slider');
        const authErrorLogin = document.getElementById('auth-error-login');
        const authErrorRegister = document.getElementById('auth-error-register');
        function toggleAuthForms(){formSlider.classList.toggle("show-register");authErrorLogin.textContent="";authErrorRegister.textContent=""}
        document.getElementById("register-btn").addEventListener("click",()=>{const a=document.getElementById("register-nickname").value.trim(),b=document.getElementById("register-email").value,c=document.getElementById("register-password").value;a?auth.createUserWithEmailAndPassword(b,c).then(c=>usersRef.child(c.user.uid).set({nickname:a,email:b})).catch(a=>{authErrorRegister.textContent=a.message}):authErrorRegister.textContent="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º."});
        document.getElementById("login-btn").addEventListener("click",()=>{const a=document.getElementById("login-email").value,b=document.getElementById("login-password").value;auth.signInWithEmailAndPassword(a,b).catch(a=>{authErrorLogin.textContent=a.message})});
        document.getElementById('save-nickname-btn').addEventListener('click',async()=>{const a=document.getElementById('new-nickname-input').value.trim(),b=auth.currentUser;if(a&&b){await usersRef.child(b.uid).update({nickname:a});const c=messagesRef.orderByChild("senderId").equalTo(b.uid),d=await c.get();if(d.exists()){const b={};d.forEach(c=>{b[`${c.key}/senderNickname`]=a}),messagesRef.update(b)}document.getElementById('user-info').textContent=a;document.getElementById('new-nickname-input').value='';settingsModal.classList.remove('open')}});
    </script>
</body>
</html>
