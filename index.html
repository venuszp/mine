<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTIMATE Кейс-Симулятор v12.2</title>
    <style>
        :root {
            --main-bg: #11111d; --panel-bg: #1c1c36; --card-color: #2b2b4a; --accent-color: #00e5ff; --hover-color: #00ffff; --shadow-color: rgba(0, 229, 255, 0.4); --item-size: 100px; --legendary-color: #ff00ff; --rare-color: gold; --epic-color: #9b59b6; --currency-color: #2ecc71; --ultra-color: #e74c3c; --sell-base: #e74c3c; --sell-hover: #ff6347;
            --common-bg: rgba(85, 85, 85, 0.2); --rare-bg: rgba(255, 215, 0, 0.15); --epic-bg: rgba(155, 89, 182, 0.2); --legendary-bg: rgba(255, 0, 255, 0.2); --ultra-bg: rgba(231, 76, 60, 0.25);
        }
        body { background: var(--main-bg); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; padding: 30px; min-height: 100vh; margin: 0; opacity: 0; transition: opacity 1s ease-in-out; position: relative; }
        body::after { content: "v12.2"; position: fixed; bottom: 5px; right: 10px; font-size: 0.8em; color: rgba(255, 255, 255, 0.15); pointer-events: none; }
        body.loaded { opacity: 1; }

        #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--main-bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; gap: 30px; }
        .loader { font-size: 80px; color: var(--accent-color); animation: bounceAndGlow 2s infinite ease-in-out; }
        #loading-text { font-size: 1.2em; color: #ccc; letter-spacing: 2px; }
        .progress-bar { width: 250px; height: 8px; background-color: var(--card-color); border-radius: 4px; overflow: hidden; }
        .progress-bar-inner { width: 100%; height: 100%; background: var(--accent-color); border-radius: 4px; animation: loadingProgress 2.5s infinite ease-in-out; }

        @keyframes bounceAndGlow { 0%, 100% { transform: translateY(0) scale(1); text-shadow: 0 0 10px var(--shadow-color); } 50% { transform: translateY(-20px) scale(1.1); text-shadow: 0 0 30px var(--shadow-color); } }
        @keyframes loadingProgress { 0% { transform: translateX(-100%); } 50% { transform: translateX(0%); } 100% { transform: translateX(100%); } }

        .auth-scene { perspective: 1000px; }
        .auth-container { width: 400px; height: 450px; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55); background: transparent; box-shadow: none; padding: 0; }
        .auth-container.flipped { transform: rotateY(180deg); }
        .auth-form { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; background: var(--panel-bg); padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9); text-align: center; gap: 20px; box-sizing: border-box; }
        #register-form { transform: rotateY(180deg); }
        .auth-form h2 { color: var(--accent-color); text-shadow: 0 0 10px var(--shadow-color); margin: 0 0 10px 0; }
        .auth-form button { background: var(--accent-color); color: var(--main-bg); border: none; padding: 15px; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.3s, transform 0.2s; }
        .auth-form button:hover { background: var(--hover-color); transform: scale(1.03); }
        .auth-form button:disabled { background: #555; cursor: not-allowed; transform: none; }
        .auth-switch { color: #ccc; } .auth-switch a { color: var(--accent-color); text-decoration: none; font-weight: bold; cursor: pointer; }
        .auth-error { color: var(--sell-base); min-height: 20px; font-weight: bold; margin-top: -10px; }

        .input-group { position: relative; }
        .input-group input { background: var(--card-color); border: 1px solid #4a4a75; color: white; padding: 15px; border-radius: 8px; font-size: 1em; width: 100%; box-sizing: border-box; }
        .input-group label { position: absolute; left: 15px; top: 16px; color: #888; pointer-events: none; transition: all 0.2s ease; }
        .input-group input:focus { outline: none; box-shadow: 0 0 10px var(--shadow-color); }
        .input-group input:focus + label, .input-group input:not(:placeholder-shown) + label { top: -10px; left: 10px; font-size: 0.8em; color: var(--accent-color); background: var(--panel-bg); padding: 0 5px; }
        
        .form-loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(28, 28, 54, 0.8); border-radius: 20px; display: none; justify-content: center; align-items: center; z-index: 10; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--card-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header-info { width: 100%; display: flex; justify-content: flex-end; align-items: center; gap: 20px; margin-bottom: 30px; }
        .settings-container { position: relative; }
        #settings-btn { background: var(--card-color); border: 1px solid #4a4a75; color: white; font-size: 1.5em; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: background 0.3s, box-shadow 0.3s; display: flex; justify-content: center; align-items: center; }
        #settings-btn:hover { background: #3e3e68; box-shadow: 0 0 10px var(--shadow-color); }
        .settings-menu { position: absolute; top: 60px; right: 0; width: 250px; background: var(--panel-bg); border-radius: 10px; border: 1px solid #4a4a75; box-shadow: 0 10px 30px rgba(0,0,0,0.7); padding: 15px; z-index: 100; display: flex; flex-direction: column; gap: 10px; opacity: 0; transform: translateY(-10px); transition: opacity 0.3s, transform 0.3s; pointer-events: none; }
        .settings-menu.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        #user-email-display { color: #ccc; font-size: 0.9em; padding-bottom: 10px; border-bottom: 1px solid var(--card-color); text-align: center; word-break: break-all; }
        #logout-btn { background: var(--sell-base); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        #logout-btn:hover { background: var(--sell-hover); }
        .post-win-modal { width: 400px; }
        #post-win-item-display { width: 150px; height: 150px; margin: 20px auto; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 15px; }
        #post-win-item-display .item-card-icon { font-size: 80px; }
        #post-win-item-name { font-size: 1.5em; font-weight: bold; margin-bottom: 20px; }
        #post-win-sell-btn { background: var(--sell-base); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; }
        #post-win-keep-btn { background: var(--currency-color); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; }
        .main-container { width: 1200px; background: var(--panel-bg); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9); padding: 30px; }
        .logo { font-family: 'Impact', sans-serif; font-size: 2.5em; color: var(--accent-color); text-shadow: 0 0 10px var(--shadow-color); margin-bottom: 20px; cursor: pointer; transition: transform 0.2s; text-align: center; }
        .logo:hover { transform: scale(1.05); }
        h2 { color: var(--accent-color); border-bottom: 2px solid var(--card-color); padding-bottom: 10px; margin-bottom: 20px; }
        .tabs { display: flex; margin-bottom: 30px; }
        .tab-button { background: var(--card-color); border: none; padding: 15px 35px; color: #ccc; font-size: 1.1em; cursor: pointer; transition: color 0.3s, background 0.3s; border-radius: 10px 10px 0 0; margin-right: 5px; }
        .tab-button.active { background: #3e3e68; color: var(--accent-color); font-weight: bold; box-shadow: inset 0 3px 0 var(--accent-color); }
        .tab-content { display: none; padding: 20px 0; opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease-out, transform 0.4s ease-out; min-height: 400px; }
        .tab-content.active { display: block; }
        .tab-content.visible { opacity: 1; transform: translateY(0); }
        .balance-display { font-size: 1.8em; color: var(--rare-color); background: var(--card-color); padding: 10px 25px; border-radius: 10px; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .case-lobby { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; }
        .case-lobby-card { width: 250px; background: var(--card-color); padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s, opacity 0.5s; border: 2px solid transparent; opacity: 0; animation: fadeInItem 0.5s ease-out forwards; }
        .case-lobby-card:nth-child(1) { animation-delay: 0s; } .case-lobby-card:nth-child(2) { animation-delay: 0.1s; } .case-lobby-card:nth-child(3) { animation-delay: 0.2s; } .case-lobby-card:nth-child(4) { animation-delay: 0.3s; }
        .case-lobby-card.fade-out { opacity: 0 !important; transform: scale(0.9); }
        .case-lobby-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5), 0 0 10px var(--accent-color); }
        .case-lobby-card h3 { margin: 5px 0 10px 0; font-size: 1.4em; }
        .case-lobby-card .icon { font-size: 50px; margin-top: 10px; }
        .case-detail-view { display: none; flex-direction: column; align-items: center; text-align: center; }
        .case-detail-view.active { display: flex; }
        .case-detail-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 20px; }
        #back-to-lobby-btn { background: var(--card-color); color: white; border: 1px solid #4a4a75; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: background 0.3s, transform 0.2s, box-shadow 0.3s; font-weight: bold; }
        #back-to-lobby-btn:hover { background: #3e3e68; transform: translateX(-5px) scale(1.05); box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); }
        #detail-case-name { flex-grow: 1; text-align: center; }
        #roll-area-container { width: 100%; max-width: 700px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 30px auto; min-height: 150px; }
        .roll-area { width: 700px; height: calc(var(--item-size) + 20px); overflow: hidden; position: relative; background: rgba(0, 0, 0, 0.5); border-radius: 10px; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.7); }
        .roll-area.small { width: 220px; height: 60px; box-shadow: 0 0 15px rgba(255, 255, 255, 0.1); overflow: hidden; }
        .roll-area.small .item-strip { top: 0; }
        .roll-area.small .item-strip .item-card { min-width: 60px; height: 60px; margin: 0 2px; padding: 0; justify-content: center; font-size: 0.6em; line-height: 1.1; }
        .roll-area.small .item-strip .item-card .item-card-icon { font-size: 25px; margin-bottom: 0; }
        .roll-area::before { content: ''; position: absolute; left: 50%; top: 0; height: 100%; width: 6px; background: #ff4d4d; z-index: 10; transform: translateX(-50%); box-shadow: 0 0 15px #ff4d4d; }
        .item-strip { position: absolute; left: 0; transition: transform 0s; display: flex; }
        .item-strip.rolling-animate { transition: transform 9s cubic-bezier(0.1, 0.8, 0.3, 1); }
        .item-card { min-width: var(--item-size); height: var(--item-size); background: #4a4a75; margin: 5px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.8em; text-align: center; user-select: none; flex-shrink: 0; border: 2px solid transparent; transition: box-shadow 0.3s; }
        .item-card .item-card-icon { font-size: 40px; margin-bottom: 5px; line-height: 1; }
        .inventory-item.rare, .item-card.rare { box-shadow: 0 0 12px rgba(255, 215, 0, 0.6), 0 0 4px var(--rare-color); }
        .inventory-item.epic, .item-card.epic { box-shadow: 0 0 12px rgba(155, 89, 182, 0.7), 0 0 4px var(--epic-color); }
        .inventory-item.legendary, .item-card.legendary { box-shadow: 0 0 15px rgba(255, 0, 255, 0.8), 0 0 5px var(--legendary-color); }
        .inventory-item.ultra, .item-card.ultra { box-shadow: 0 0 18px rgba(231, 76, 60, 0.9), 0 0 6px var(--ultra-color); animation: ultraGlow 1s infinite alternate; }
        @keyframes ultraGlow { 0% { box-shadow: 0 0 10px var(--ultra-color); } 100% { box-shadow: 0 0 25px var(--ultra-color), 0 0 5px #fff; } }
        .case-buttons-controls { display: flex; flex-direction: column; align-items: center; width: 700px; }
        .quick-open-toggle-container { margin-bottom: 15px; background: var(--card-color); padding: 8px 15px; border-radius: 8px; display: flex; align-items: center; border: 1px solid #4a4a75; transition: box-shadow 0.3s; }
        .quick-open-toggle-container:hover { box-shadow: 0 0 10px var(--accent-color); }
        .case-buttons-group { display: flex; justify-content: center; gap: 20px; width: 100%; }
        .open-case-btn { position: relative; overflow: hidden; z-index: 1; background: var(--accent-color); color: var(--main-bg); border: none; padding: 12px 30px; font-size: 1.1em; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background 0.3s, transform 0.3s; box-shadow: 0 5px 15px var(--shadow-color); width: 30%; }
        .open-case-btn.pack-open-btn { background: var(--currency-color); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.5); }
        .open-case-btn:hover { transform: scale(1.03); }
        .open-case-btn::after { content: ''; position: absolute; top: 0; left: -200%; width: 100%; height: 100%; background: linear-gradient( to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.5) 50%, rgba(255, 255, 255, 0) 100% ); transform: skewX(-20deg); transition: all 0.3s; z-index: 2; }
        .open-case-btn:hover::after { left: 200%; transition: all 0.7s cubic-bezier(0.19, 1, 0.22, 1); }
        .open-case-btn:disabled { background: #555; cursor: not-allowed; box-shadow: none; transform: scale(1); }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        #sell-all-btn { background: var(--sell-base); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
        #sell-all-btn:hover { background: var(--sell-hover); }
        .common { background: linear-gradient(135deg, #444, #333); color: #ccc; }
        .rare { background: linear-gradient(135deg, #7d7d00, #4a4a75); color: var(--rare-color); }
        .epic { background: linear-gradient(135deg, #5f3c5f, #4a4a75); color: var(--epic-color); }
        .legendary { background: radial-gradient(circle at 70% 30%, #ff00ff, #3c5f5f); color: var(--legendary-color); }
        .ultra { background: radial-gradient(circle at 70% 30%, #e74c3c, #3c235f); color: var(--ultra-color); }
        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .notification { background: #2ecc71; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); margin-bottom: 10px; opacity: 0; transform: translateX(100%); transition: opacity 0.5s ease-out, transform 0.5s ease-out; max-width: 300px; font-weight: 500; display: flex; justify-content: space-between; align-items: center; }
        .notification .count { background: rgba(0, 0, 0, 0.2); padding: 2px 8px; border-radius: 50%; margin-left: 10px; font-size: 0.9em; font-weight: bold; }
        .notification.error { background: #e74c3c; }
        .notification.show { opacity: 1; transform: translateX(0); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--panel-bg); padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7); text-align: center; transform: scale(0.8); opacity: 0; transition: all 0.3s ease-in-out; max-width: 400px; }
        .modal-overlay.active .modal-content { transform: scale(1); opacity: 1; }
        .modal-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #confirm-sell-btn { background: var(--sell-base); color: white; }
        #cancel-sell-btn { background: #555; color: white; }
        .inventory-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px; }
        .inventory-list { display: flex; flex-wrap: wrap; gap: 20px; padding: 10px; justify-content: center; }
        .inventory-item { width: 140px; background: var(--card-color); border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); opacity: 0; transform: translateY(10px); animation: fadeInItem 0.5s ease-out forwards; }
        @keyframes fadeInItem { to { opacity: 1; transform: translateY(0); } }
        .sell-btn { background: var(--sell-base); color: white; border: none; padding: 8px 15px; margin-top: 10px; border-radius: 5px; cursor: pointer; font-size: 0.9em; width: 100%; transition: background 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
        .sell-btn:hover { background: var(--sell-hover); box-shadow: 0 0 15px rgba(255, 99, 71, 0.8); }
        .buy-button { font-size: 1.2em; font-weight: bold; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; transition: transform 0.2s, box-shadow 0.3s;}
        .buy-button:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(46, 204, 113, 0.6); }
        .case-info { display: grid; grid-template-columns: 1fr 1fr; width: 100%; max-width: 800px; margin: 30px auto 0 auto; gap: 30px; }
        .chances-list { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; width: 100%; }
        .chance-item { display: flex; justify-content: space-between; padding: 8px 12px; border-radius: 5px; margin-bottom: 5px; transition: transform 0.2s, box-shadow 0.2s; }
        .chance-item:hover { transform: scale(1.03); box-shadow: 0 0 10px rgba(255, 255, 255, 0.1); }
        .chance-item.common { background: var(--common-bg); } .chance-item.rare { background: var(--rare-bg); } .chance-item.epic { background: var(--epic-bg); } .chance-item.legendary { background: var(--legendary-bg); } .chance-item.ultra { background: var(--ultra-bg); }
        .chance-item span:first-child { font-weight: bold; } .chance-item span:last-child { color: #ccc; } .chance-item.rare span:first-child { color: var(--rare-color); } .chance-item.epic span:first-child { color: var(--epic-color); } .chance-item.legendary span:first-child { color: var(--legendary-color); } .chance-item.ultra span:first-child { color: var(--ultra-color); }
        #items-content { display: flex; flex-direction: column; gap: 5px; }
        .content-item { display: flex; align-items: center; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 5px; transition: transform 0.2s, box-shadow 0.2s; }
        .content-item:hover { transform: scale(1.03); box-shadow: 0 0 10px rgba(255, 255, 255, 0.1); }
        .content-item .item-icon { font-size: 24px; margin-right: 15px; width: 30px; text-align: center;}
        .content-item .item-details { flex-grow: 1; } .content-item .item-details .item-name { font-weight: bold; } .content-item .item-details .item-sell { font-size: 0.9em; color: var(--rare-color); opacity: 0.8; }
        .content-item.common .item-name { color: white; } .content-item.rare .item-name { color: var(--rare-color); } .content-item.epic .item-name { color: var(--epic-color); } .content-item.legendary .item-name { color: var(--legendary-color); } .content-item.ultra .item-name { color: var(--ultra-color); }
        #chat-toggle-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--accent-color); color: var(--main-bg); border: none; font-size: 2em; cursor: pointer; display: none; justify-content: center; align-items: center; box-shadow: 0 5px 20px var(--shadow-color); z-index: 2001; transition: transform 0.3s, background 0.3s; }
        #chat-toggle-btn:hover { transform: scale(1.1); background: var(--hover-color); }
        #chat-container { position: fixed; bottom: 100px; right: 30px; width: 380px; height: 500px; background: var(--panel-bg); border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); display: flex; flex-direction: column; z-index: 2000; opacity: 0; transform: translateY(20px) scale(0.95); transition: opacity 0.3s, transform 0.3s; pointer-events: none; }
        #chat-container.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .chat-header { background: var(--card-color); padding: 10px 15px; border-radius: 15px 15px 0 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-header-btn { background: none; border: none; color: white; font-size: 1.2em; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; margin-left: 10px; }
        .chat-header-btn:hover { opacity: 1; }
        #chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .message { padding: 8px 12px; border-radius: 10px; max-width: 80%; animation: fadeInMessage 0.4s ease-out; }
        @keyframes fadeInMessage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.received { background: var(--card-color); align-self: flex-start; }
        .message.sent { background: #3e3e68; align-self: flex-end; }
        .message-nick { font-weight: bold; font-size: 0.9em; margin-bottom: 4px; color: var(--accent-color); }
        .message.sent .message-nick { color: var(--rare-color); }
        .message-text { margin: 0; word-wrap: break-word; }
        #chat-form { display: flex; padding: 10px; border-top: 1px solid var(--card-color); }
        #chat-input { flex-grow: 1; background: var(--card-color); border: none; color: white; padding: 10px; border-radius: 8px; margin-right: 10px; }
        #chat-input:focus { outline: none; }
        #chat-form button { background: var(--accent-color); border: none; color: var(--main-bg); font-weight: bold; font-size: 1.2em; border-radius: 8px; width: 45px; cursor: pointer; }
        .chat-settings-input { width: 100%; padding: 10px; margin: 10px 0; background: var(--card-color); border: 1px solid #4a4a75; color: white; border-radius: 5px; }

        /* --- БЛОК АДАПТАЦИИ ДЛЯ МОБИЛЬНЫХ УСТРОЙСТВ --- */
        @media (max-width: 768px) {
            body { padding: 15px 5px; }
            .main-container { width: 95vw; padding: 15px; }
            .logo { font-size: 1.8em; }
            h2 { font-size: 1.2em; }
            .header-info { padding: 10px; justify-content: space-between; }
            .balance-display { font-size: 1.3em; padding: 8px 15px;}
            
            .tabs { justify-content: space-around; }
            .tab-button { padding: 12px 10px; font-size: 0.9em; margin-right: 2px; }

            .case-lobby-card { width: calc(50% - 20px); }
            
            .case-detail-header { flex-direction: column; gap: 15px; }
            #roll-area-container, .roll-area, .case-buttons-controls { width: 100%; max-width: 100%; }
            .case-buttons-group { flex-direction: column; align-items: center; width: 100%; }
            .open-case-btn { width: 80%; padding: 15px; font-size: 1em; }
            
            .case-info { grid-template-columns: 1fr; }

            .inventory-item { width: calc(50% - 20px); }
            .inventory-top-bar { flex-direction: column; gap: 15px; }
            
            #chat-container { width: 95vw; right: 2.5vw; bottom: 80px; height: 400px; }
            #chat-toggle-btn { bottom: 20px; right: 20px; }
            
            .auth-container { width: 90vw; }
        }
    </style>
</head>
<body>
    <div id="loading-container">
        <div class="loader">💎</div>
        <div id="loading-text">ЗАГРУЗКА...</div>
        <div class="progress-bar"><div class="progress-bar-inner"></div></div>
    </div>

    <audio id="case-open-sound" src="sounds/case_open.mp3" preload="auto"></audio>
    <audio id="item-win-sound" src="sounds/item_win.mp3" preload="auto"></audio>
    <audio id="message-sent-sound" src="sounds/message_sent.mp3" preload="auto"></audio>
    <audio id="tab-switch-sound" src="sounds/tab_switch.mp3" preload="auto"></audio>
    <audio id="toggle-click-sound" src="sounds/toggle_click.mp3" preload="auto"></audio>
    <audio id="sell-sound" src="sounds/sell_item.mp3" preload="auto"></audio>
    <audio id="button-click-sound"src="sounds/button_click.mp3" preload="auto"></audio>

    <div id="auth-scene" class="auth-scene" style="display: none;">
        <div id="auth-container" class="auth-container">
            <form id="login-form" class="auth-form">
                <div class="form-loader"><div class="spinner"></div></div>
                <h2>Вход в аккаунт</h2>
                <div class="input-group">
                    <input type="email" id="login-email" placeholder=" " required>
                    <label for="login-email">Email</label>
                </div>
                <div class="input-group">
                    <input type="password" id="login-password" placeholder=" " required>
                    <label for="login-password">Пароль</label>
                </div>
                <button type="submit">Войти</button>
                <p id="login-error" class="auth-error"></p>
                <p class="auth-switch">Нет аккаунта? <a id="show-register">Зарегистрироваться</a></p>
            </form>
            <form id="register-form" class="auth-form">
                <div class="form-loader"><div class="spinner"></div></div>
                <h2>Создание аккаунта</h2>
                <div class="input-group">
                    <input type="email" id="register-email" placeholder=" " required>
                    <label for="register-email">Email</label>
                </div>
                <div class="input-group">
                    <input type="password" id="register-password" placeholder=" " required>
                    <label for="register-password">Пароль (мин. 6 симв.)</label>
                </div>
                <button type="submit">Создать</button>
                <p id="register-error" class="auth-error"></p>
                <p class="auth-switch">Уже есть аккаунт? <a id="show-login">Войти</a></p>
            </form>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <div class="modal-overlay" id="sell-modal-overlay"><div class="modal-content"><h3 style="color: #ff4d4d;">Подтверждение продажи</h3><p id="modal-sell-text"></p><div class="modal-buttons"><button id="confirm-sell-btn">Продать</button><button id="cancel-sell-btn">Отмена</button></div></div></div>
        <div class="modal-overlay" id="post-win-modal-overlay"><div class="modal-content post-win-modal"><h2>ВЫИГРЫШ!</h2><div id="post-win-item-display"></div><p id="post-win-item-name"></p><div class="modal-buttons"><button id="post-win-sell-btn">Продать</button><button id="post-win-keep-btn">Оставить</button></div></div></div>
        <div class="modal-overlay" id="chat-settings-modal-overlay"><div class="modal-content"><h3>Настройки чата</h3><label for="nickname-input">Ваш никнейм:</label><input type="text" id="nickname-input" class="chat-settings-input" maxlength="20" placeholder="Введите ник..."><div class="modal-buttons"><button id="save-nickname-btn">Сохранить</button><button id="cancel-nickname-btn">Отмена</button></div></div></div>
        <div id="notification-container"></div>
        <div class="header-info"><div id="balance" class="balance-display">0 💎</div><div class="settings-container"><button id="settings-btn">⚙️</button><div id="settings-menu" class="settings-menu"><div id="user-email-display"></div><button id="logout-btn">Выйти</button></div></div></div>
        <div class="main-container">
            <div class="logo" id="main-logo">CASE SIMULATOR v12.2</div>
            <div class="tabs"><button class="tab-button" data-tab="cases">Кейсы</button><button class="tab-button" data-tab="inventory">Инвентарь</button><button class="tab-button" data-tab="shop">Магазин</button></div>
            <div id="cases" class="tab-content case-section">
                <div id="case-lobby-view" class="case-detail-view"><h2>Выбор Кейса</h2>
                    <div class="case-lobby">
                        <div class="case-lobby-card" data-case-id="bread"><div class="icon">🍞</div><h3>Хлебный</h3><p class="price">150 💎</p></div>
                        <div class="case-lobby-card" data-case-id="chupachups"><div class="icon">🍬</div><h3>Чупа-Чупс</h3><p class="price">300 💎</p></div>
                        <div class="case-lobby-card" data-case-id="honey"><div class="icon" style="color: gold;">🍯</div><h3 style="color: gold;">Медовый</h3><p class="price">700 💎</p></div>
                        <div class="case-lobby-card" data-case-id="trucker"><div class="icon">🚛</div><h3>Дальнобойщик</h3><p class="price">2000 💎</p></div>
                        <div class="case-lobby-card" data-case-id="banker"><div class="icon" style="color: #2ecc71;">🏦</div><h3 style="color: #2ecc71;">Банкир</h3><p class="price">8000 💎</p></div>
                        <div class="case-lobby-card" data-case-id="debtor"><div class="icon" style="color: var(--ultra-color);">🕴️</div><h3 style="color: var(--ultra-color);">Должник</h3><p class="price">25000 💎</p></div>
                    </div>
                </div>
                <div id="case-detail-view" class="case-detail-view"><div class="case-detail-header"><button id="back-to-lobby-btn">← Назад</button><h2 id="detail-case-name"></h2><span></span></div><div id="roll-area-container"></div><div class="case-buttons-controls"><div class="quick-open-toggle-container"><label for="quick-open-toggle">Мгновенное открытие:</label><label class="switch"><input type="checkbox" id="quick-open-toggle"><span class="slider"></span></label></div><div class="case-buttons-group"><button class="open-case-btn" data-type="animated" data-amount="1">Открыть 1</button><button class="open-case-btn pack-open-btn" data-type="animated" data-amount="10">Открыть x10</button></div></div><div id="status-message" style="margin-top: 35px; font-style: italic; font-size: 1.1em;"></div><div class="case-info"><div class="chances-list"><h4>Шансы:</h4><div id="chances-content"></div></div><div class="chances-list"><h4>Содержимое:</h4><div id="items-content"></div></div></div></div>
            </div>
            <div id="inventory" class="tab-content"><div class="inventory-top-bar"><h2>Ваши Предметы</h2><div><button id="sell-all-btn" class="open-case-btn" style="width: auto; margin: 0; box-shadow: none;">Продать Всё</button><div class="toggle-switch-container" style="display: inline-flex; margin-left: 20px;"><label for="sell-confirm-toggle">Мгн. продажа:</label><label class="switch"><input type="checkbox" id="sell-confirm-toggle"><span class="slider"></span></label></div></div></div><div id="inventory-list" class="inventory-list"><p style="padding: 20px;">Инвентарь пуст.</p></div></div>
            <div id="shop" class="tab-content" style="text-align: center;"><h2>Магазин</h2><p>Здесь могут быть ваши предложения.</p></div>
        </div>
    </div>

    <button id="chat-toggle-btn">💬</button>
    <div id="chat-container">
        <div class="chat-header"><span>Общий чат</span><div><button id="chat-settings-btn" class="chat-header-btn">⚙️</button><button id="chat-close-btn" class="chat-header-btn">✖</button></div></div>
        <div id="chat-messages"></div>
        <form id="chat-form"><input type="text" id="chat-input" placeholder="Введите сообщение..." autocomplete="off" maxlength="100"><button type="submit">➤</button></form>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, get, set, onChildAdded, push, serverTimestamp, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBTcH3_tri2L7AHLh1e-YD-0s-QSthuE6Q", authDomain: "disk-c98ee.firebaseapp.com", projectId: "disk-c98ee", storageBucket: "disk-c98ee.appspot.com", messagingSenderId: "59577059636", appId: "1:59577059636:web:e98f456d054cc360747d61", databaseURL: "https://disk-c98ee-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', () => {
            const loadingContainer = document.getElementById('loading-container');
            const authScene = document.getElementById('auth-scene');
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterLink = document.getElementById('show-register');
            const showLoginLink = document.getElementById('show-login');
            const loginError = document.getElementById('login-error');
            const registerError = document.getElementById('register-error');
            
            const loginLoader = loginForm.querySelector('.form-loader');
            const registerLoader = registerForm.querySelector('.form-loader');
            const loginButton = loginForm.querySelector('button');
            const registerButton = registerForm.querySelector('button');

            const settingsBtn = document.getElementById('settings-btn');
            const settingsMenu = document.getElementById('settings-menu');
            const userEmailDisplay = document.getElementById('user-email-display');
            const logoutBtn = document.getElementById('logout-btn');
            const balanceDisplay = document.getElementById('balance');
            const inventoryList = document.getElementById('inventory-list');
            const statusMessage = document.getElementById('status-message');
            const notificationContainer = document.getElementById('notification-container');
            const sellModalOverlay = document.getElementById('sell-modal-overlay');
            const modalSellText = document.getElementById('modal-sell-text');
            const confirmSellBtn = document.getElementById('confirm-sell-btn');
            const cancelSellBtn = document.getElementById('cancel-sell-btn');
            const postWinModalOverlay = document.getElementById('post-win-modal-overlay');
            const postWinItemDisplay = document.getElementById('post-win-item-display');
            const postWinItemName = document.getElementById('post-win-item-name');
            const postWinSellBtn = document.getElementById('post-win-sell-btn');
            const postWinKeepBtn = document.getElementById('post-win-keep-btn');
            const addBalanceBtn = document.getElementById('add-balance-btn');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const caseLobbyView = document.getElementById('case-lobby-view');
            const caseDetailView = document.getElementById('case-detail-view');
            const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
            const detailCaseName = document.getElementById('detail-case-name');
            const rollAreaContainer = document.getElementById('roll-area-container');
            const detailOpenButtons = caseDetailView.querySelectorAll('.open-case-btn');
            const sellAllBtn = document.getElementById('sell-all-btn');
            const quickOpenToggle = document.getElementById('quick-open-toggle');
            const sellConfirmToggle = document.getElementById('sell-confirm-toggle');
            const mainLogo = document.getElementById('main-logo');
            const chancesContent = document.getElementById('chances-content');
            const itemsContent = document.getElementById('items-content');
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            const chatContainer = document.getElementById('chat-container');
            const chatCloseBtn = document.getElementById('chat-close-btn');
            const chatSettingsBtn = document.getElementById('chat-settings-btn');
            const chatMessages = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatSettingsModal = document.getElementById('chat-settings-modal-overlay');
            const nicknameInput = document.getElementById('nickname-input');
            const saveNicknameBtn = document.getElementById('save-nickname-btn');
            const cancelNicknameBtn = document.getElementById('cancel-nickname-btn');
            const caseOpenSound = document.getElementById('case-open-sound');
            const messageSentSound = document.getElementById('message-sent-sound');
            const itemWinSound = document.getElementById('item-win-sound');
            const tabSwitchSound = document.getElementById('tab-switch-sound');
            const toggleClickSound = document.getElementById('toggle-click-sound');
            const sellSound = document.getElementById('sell-sound');
            const buttonClickSound = document.getElementById('button-click-sound');
            
            let balance = 0;
            let CURRENT_CASE_ID = null;
            let itemToSell = null;
            let currentItemWon = null;
            let currentUserNickname = 'Гость';
            const INVENTORY = [];
            const ANIMATION_DURATION = 9000;
            const FINAL_PAUSE_DURATION = 1000;
            
            const ALL_ITEMS = [ { id: 101, name: "Черствая корка", rarity: 40, icon: '🧱', class: 'common', sell: 10, case: 'bread' }, { id: 102, name: "Батон 'Нарезной'", rarity: 30, icon: '🥖', class: 'common', sell: 25, case: 'bread' }, { id: 103, name: "Пакет муки", rarity: 20, icon: '🥡', class: 'rare', sell: 80, case: 'bread' }, { id: 104, name: "Золотой багет", rarity: 9, icon: '🥐', class: 'epic', sell: 250, case: 'bread' }, { id: 105, name: "Вечная буханка", rarity: 1, icon: '🍞', class: 'legendary', sell: 1000, case: 'bread' }, { id: 201, name: "Ложка дегтя", rarity: 45, icon: '🥄', class: 'common', sell: 50, case: 'honey' }, { id: 202, name: "Луговой мёд", rarity: 25, icon: '🌼', class: 'rare', sell: 200, case: 'honey' }, { id: 203, name: "Пчелиные соты", rarity: 18, icon: '🐝', class: 'rare', sell: 400, case: 'honey' }, { id: 204, name: "Бочка мёда", rarity: 10, icon: '🍯', class: 'epic', sell: 1200, case: 'honey' }, { id: 205, name: "Пасека", rarity: 2, icon: '🏞️', class: 'legendary', sell: 5000, case: 'honey' }, { id: 301, name: "Пачка сигарет", rarity: 40, icon: '🚬', class: 'common', sell: 150, case: 'trucker' }, { id: 302, name: "Канистра ДТ", rarity: 30, icon: '⛽', class: 'rare', sell: 500, case: 'trucker' }, { id: 303, name: "Новенькая фура", rarity: 20, icon: '🚚', class: 'epic', sell: 2500, case: 'trucker' }, { id: 304, name: "Золотой номер", rarity: 8, icon: 'ทะเบียน', class: 'legendary', sell: 10000, case: 'trucker' }, { id: 305, name: "Собственная автоколонна", rarity: 2, icon: '🚛', class: 'ultra', sell: 40000, case: 'trucker' }, { id: 401, name: "Пачка купюр", rarity: 50, icon: '💵', class: 'rare', sell: 1000, case: 'banker' }, { id: 402, name: "Слиток золота", rarity: 25, icon: '🪙', class: 'epic', sell: 5000, case: 'banker' }, { id: 403, name: "Мешок с деньгами", rarity: 15, icon: '💰', class: 'epic', sell: 12000, case: 'banker' }, { id: 404, name: "Акции 'Case Corp'", rarity: 8, icon: '📈', class: 'legendary', sell: 40000, case: 'banker' }, { id: 405, name: "Личный банк", rarity: 2, icon: '🏦', class: 'ultra', sell: 150000, case: 'banker' }, { id: 501, name: "Клубничный", rarity: 40, icon: '🍓', class: 'common', sell: 20, case: 'chupachups' }, { id: 502, name: "Апельсиновый", rarity: 30, icon: '🍊', class: 'common', sell: 20, case: 'chupachups' }, { id: 503, name: "Со вкусом Колы", rarity: 20, icon: '🥤', class: 'rare', sell: 100, case: 'chupachups' }, { id: 504, name: "XXL Чупа-Чупс", rarity: 9, icon: '🍭', class: 'epic', sell: 400, case: 'chupachups' }, { id: 505, name: "Золотой Чупа-Чупс", rarity: 1, icon: '🏆', class: 'legendary', sell: 1500, case: 'chupachups' }, { id: 601, name: "Звонок от коллектора", rarity: 50, icon: '📞', class: 'common', sell: 500, case: 'debtor' }, { id: 602, name: "Повестка в суд", rarity: 25, icon: '⚖️', class: 'rare', sell: 4000, case: 'debtor' }, { id: 603, name: "Проданный долг", rarity: 15, icon: '🧾', class: 'epic', sell: 20000, case: 'debtor' }, { id: 604, name: "Списанный кредит", rarity: 8, icon: '📑', class: 'legendary', sell: 100000, case: 'debtor' }, { id: 605, name: "Свобода от долгов", rarity: 2, icon: '🕊️', class: 'ultra', sell: 500000, case: 'debtor' } ];
            const CASES = { bread: { name: 'Хлебный', price: 150, icon: '🍞' }, chupachups: { name: 'Чупа-Чупс', price: 300, icon: '🍬' }, honey: { name: 'Медовый', price: 700, icon: '🍯' }, trucker: { name: 'Дальнобойщик', price: 2000, icon: '🚛' }, banker: { name: 'Банкир', price: 8000, icon: '🏦' }, debtor: { name: 'Должник', price: 25000, icon: '🕴️' } };
            
            onAuthStateChanged(auth, async (user) => { if (user) { await initializeGameForUser(user); loadingContainer.style.display = 'none'; authScene.style.display = 'none'; appContainer.style.display = 'block'; chatToggleBtn.style.display = 'flex'; } else { loadingContainer.style.display = 'none'; authScene.style.display = 'flex'; appContainer.style.display = 'none'; chatToggleBtn.style.display = 'none'; resetGameState(); } document.body.classList.add('loaded'); });
            
            showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); authContainer.classList.add('flipped'); });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); authContainer.classList.remove('flipped'); });
            
            settingsBtn.addEventListener('click', () => { settingsMenu.classList.toggle('active'); buttonClickSound.play(); });
            document.addEventListener('click', (e) => { if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) { settingsMenu.classList.remove('active'); } });

            async function loadUserData(userId) { try { const snapshot = await get(ref(database, 'users/' + userId)); if (snapshot.exists()) { const data = snapshot.val(); return { balance: data.balance || 1000, inventory: data.inventory || [], nickname: data.nickname || `User${Math.floor(Math.random() * 1000)}` }; } return { balance: 1000, inventory: [], nickname: `User${Math.floor(Math.random() * 1000)}` }; } catch (error) { console.error("Ошибка загрузки:", error); return { balance: 1000, inventory: [], nickname: 'ErrorUser' }; } }
            function saveUserData(userId, data) { if (!userId) return; set(ref(database, 'users/' + userId), data).catch(error => console.error("Ошибка сохранения:", error)); }
            async function initializeGameForUser(user) { userEmailDisplay.textContent = user.email; const userData = await loadUserData(user.uid); balance = userData.balance; currentUserNickname = userData.nickname; INVENTORY.length = 0; INVENTORY.push(...(Array.isArray(userData.inventory) ? userData.inventory : Object.values(userData.inventory))); updateBalance(); renderInventory(); const caseTab = document.getElementById('cases'), caseTabButton = document.querySelector('.tab-button[data-tab="cases"]'); tabContents.forEach(c => c.classList.remove('active', 'visible')); tabButtons.forEach(b => b.classList.remove('active')); caseTab.classList.add('active', 'visible'); caseTabButton.classList.add('active'); goToLobby(); initializeChat(); }
            function resetGameState() { balance = 0; currentUserNickname = 'Гость'; INVENTORY.length = 0; updateBalance(); renderInventory(); userEmailDisplay.textContent = ''; settingsMenu.classList.remove('active'); chatContainer.classList.remove('open'); }
            function initializeChat() { chatMessages.innerHTML = ''; const chatRef = query(ref(database, 'chat'), limitToLast(50)); onChildAdded(chatRef, (snapshot) => displayChatMessage(snapshot.val())); }
            function displayChatMessage({ uid, nick, text }) { const msgElement = document.createElement('div'); msgElement.classList.add('message', uid === auth.currentUser.uid ? 'sent' : 'received'); msgElement.innerHTML = `<div class="message-nick">${nick}</div><p class="message-text">${text}</p>`; chatMessages.appendChild(msgElement); chatMessages.scrollTop = chatMessages.scrollHeight; }
            chatForm.addEventListener('submit', (e) => { e.preventDefault(); const text = chatInput.value.trim(); if (text && auth.currentUser) { push(ref(database, 'chat'), { uid: auth.currentUser.uid, nick: currentUserNickname, text, timestamp: serverTimestamp() }); chatInput.value = ''; messageSentSound.play(); } });
            
            loginForm.addEventListener('submit', async e => { e.preventDefault(); loginLoader.style.display = 'flex'; loginButton.disabled = true; try { await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value); loginError.textContent = ''; } catch (error) { loginError.textContent = 'Ошибка! Неверный email или пароль.'; } finally { loginLoader.style.display = 'none'; loginButton.disabled = false; } });
            
            registerForm.addEventListener('submit', async e => { e.preventDefault(); registerLoader.style.display = 'flex'; registerButton.disabled = true; try { await createUserWithEmailAndPassword(auth, registerForm['register-email'].value, registerForm['register-password'].value); registerError.textContent = ''; } catch (error) { registerError.textContent = 'Ошибка! Проверьте email или пароль.'; } finally { registerLoader.style.display = 'none'; registerButton.disabled = false; } });
            
            function updateBalance() { balanceDisplay.textContent = `${balance} 💎`; if (auth.currentUser) saveUserData(auth.currentUser.uid, { balance, inventory: INVENTORY, nickname: currentUserNickname }); }
            function showNotification(message, type = 'success', duration = 3000) { const cleanMessage = message.split(' x')[0]; const existingNote = Array.from(notificationContainer.children).find(note => note.textContent.startsWith(cleanMessage)); if (existingNote) { let count = parseInt(existingNote.dataset.count || 1) + 1; existingNote.dataset.count = count; let span = existingNote.querySelector('.count'); if (!span) { span = document.createElement('span'); span.className = 'count'; existingNote.appendChild(span); } span.textContent = `x${count}`; clearTimeout(existingNote.timer); existingNote.timer = setTimeout(() => { existingNote.classList.remove('show'); setTimeout(() => { existingNote.remove(); }, 500); }, duration); return; } const note = document.createElement('div'); note.className = `notification ${type}`; note.textContent = cleanMessage; note.dataset.count = 1; notificationContainer.prepend(note); setTimeout(() => { note.classList.add('show'); }, 10); note.timer = setTimeout(() => { note.classList.remove('show'); setTimeout(() => { note.remove(); }, 500); }, duration); }
            function renderInventory() { inventoryList.innerHTML = ''; if (INVENTORY.length === 0) { inventoryList.innerHTML = '<p style="width: 100%; text-align: center; padding: 20px;">Инвентарь пуст.</p>'; return; } INVENTORY.forEach((item, index) => { const itemElement = document.createElement('div'); itemElement.className = `inventory-item ${item.class}`; itemElement.style.animationDelay = `${index * 0.05}s`; itemElement.innerHTML = `<div class="item-card-icon">${item.icon}</div><div class="item-name">${item.name}</div><button class="sell-btn" data-unique-id="${item.uniqueId}">Продать за ${item.sell} 💎</button>`; inventoryList.appendChild(itemElement); }); inventoryList.querySelectorAll('.sell-btn').forEach(button => button.addEventListener('click', prepareSellItem)); }
            function sellAllItems() { if (INVENTORY.length === 0) { showNotification("Инвентарь пуст!", 'error'); return; } const totalValue = INVENTORY.reduce((sum, item) => sum + item.sell, 0); balance += totalValue; showNotification(`Продано ${INVENTORY.length} предметов (+${totalValue} 💎)`, 'success', 5000); INVENTORY.length = 0; sellSound.play(); updateBalance(); renderInventory(); }
            function prepareSellItem(event) { const uniqueId = event.target.dataset.uniqueId; itemToSell = INVENTORY.find(item => item.uniqueId === parseFloat(uniqueId)); if (!itemToSell) return; if (sellConfirmToggle.checked) { performSell(); } else { modalSellText.innerHTML = `Продать <strong>${itemToSell.name}</strong> за ${itemToSell.sell} 💎?`; sellModalOverlay.classList.add('active'); } }
            function performSell() { const indexToRemove = INVENTORY.findIndex(item => item.uniqueId === itemToSell.uniqueId); if (indexToRemove !== -1) { balance += itemToSell.sell; showNotification(`Продано: ${itemToSell.name} (+${itemToSell.sell} 💎)`, 'success'); INVENTORY.splice(indexToRemove, 1); sellSound.play(); updateBalance(); renderInventory(); } itemToSell = null; sellModalOverlay.classList.remove('active'); }
            function getRandomItem(caseId) { const caseItems = ALL_ITEMS.filter(item => item.case === caseId); const totalRarity = caseItems.reduce((sum, item) => sum + item.rarity, 0); let randomNumber = Math.random() * totalRarity; for (const item of caseItems) { randomNumber -= item.rarity; if (randomNumber <= 0) return item; } return caseItems[0]; }
            function completeCaseOpening(winningItems) { document.querySelectorAll('.open-case-btn').forEach(btn => btn.disabled = false); if (winningItems.length === 1) { showPostWinModal(winningItems[0]); } else { const totalSell = winningItems.reduce((sum, item) => sum + item.sell, 0); winningItems.forEach(item => INVENTORY.push({ ...item, uniqueId: Date.now() + Math.random() })); rollAreaContainer.innerHTML = `<h3 style="color: var(--rare-color);">Открыто ${winningItems.length} кейсов!</h3>`; showNotification(`Выпало ${winningItems.length} предметов. Общая стоимость: ${totalSell} 💎`, 'success', 5000); renderInventoryAndUpdate(); if (quickOpenToggle.checked) itemWinSound.play(); } }
            function showPostWinModal(item) { currentItemWon = item; postWinItemDisplay.className = `inventory-item ${item.class}`; postWinItemDisplay.innerHTML = `<div class="item-card-icon">${item.icon}</div>`; postWinItemName.textContent = item.name; postWinItemName.style.color = `var(--${item.class}-color, white)`; postWinSellBtn.textContent = `Продать за ${item.sell} 💎`; postWinModalOverlay.classList.add('active'); itemWinSound.play(); }
            function renderInventoryAndUpdate() { renderInventory(); updateBalance(); if (CURRENT_CASE_ID) { const rollArea = createRollAreaElement(CURRENT_CASE_ID, false); rollAreaContainer.innerHTML = ''; rollAreaContainer.appendChild(rollArea); generateStrip(rollArea.querySelector('.item-strip'), getRandomItem(CURRENT_CASE_ID)); } }
            tabButtons.forEach(button => { button.addEventListener('click', () => { tabSwitchSound.play(); const targetTabId = button.dataset.tab; tabContents.forEach(content => content.classList.remove('visible')); setTimeout(() => { tabContents.forEach(content => content.classList.remove('active')); tabButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); const targetContent = document.getElementById(targetTabId); targetContent.classList.add('active'); setTimeout(() => { targetContent.classList.add('visible'); }, 50); }, 400); }); });
            [quickOpenToggle, sellConfirmToggle].forEach(toggle => toggle.addEventListener('change', () => toggleClickSound.play()));
            postWinSellBtn.addEventListener('click', () => { if (!currentItemWon) return; balance += currentItemWon.sell; showNotification(`Продано: ${currentItemWon.name} (+${currentItemWon.sell} 💎)`, 'success'); postWinModalOverlay.classList.remove('active'); renderInventoryAndUpdate(); currentItemWon = null; sellSound.play(); });
            postWinKeepBtn.addEventListener('click', () => { if (!currentItemWon) return; INVENTORY.push({ ...currentItemWon, uniqueId: Date.now() + Math.random() }); showNotification(`Добавлено в инвентарь: ${currentItemWon.name}`, 'success'); postWinModalOverlay.classList.remove('active'); renderInventoryAndUpdate(); currentItemWon = null; buttonClickSound.play(); });
            confirmSellBtn.addEventListener('click', () => { performSell(); });
            cancelSellBtn.addEventListener('click', () => { sellModalOverlay.classList.remove('active'); itemToSell = null; buttonClickSound.play(); });
            sellAllBtn.addEventListener('click', () => { sellAllItems(); });
            detailOpenButtons.forEach(button => button.addEventListener('click', handleOpenCase));
            backToLobbyBtn.addEventListener('click', () => { goToLobby(); buttonClickSound.play(); });
            mainLogo.addEventListener('click', () => { goToLobby(); buttonClickSound.play(); });
            logoutBtn.addEventListener('click', () => { signOut(auth); buttonClickSound.play(); });
            document.querySelectorAll('.case-lobby-card').forEach(card => card.addEventListener('click', () => { renderCaseDetails(card.dataset.caseId); buttonClickSound.play(); }));
            chatToggleBtn.addEventListener('click', () => { chatContainer.classList.toggle('open'); buttonClickSound.play(); });
            chatCloseBtn.addEventListener('click', () => { chatContainer.classList.remove('open'); buttonClickSound.play(); });
            chatSettingsBtn.addEventListener('click', () => { nicknameInput.value = currentUserNickname; chatSettingsModal.classList.add('active'); buttonClickSound.play(); });
            saveNicknameBtn.addEventListener('click', () => { const newNick = nicknameInput.value.trim(); if (newNick && newNick !== currentUserNickname) { currentUserNickname = newNick; saveUserData(auth.currentUser.uid, { balance, inventory: INVENTORY, nickname: newNick }); showNotification('Никнейм успешно изменен!', 'success'); } chatSettingsModal.classList.remove('active'); buttonClickSound.play(); });
            cancelNicknameBtn.addEventListener('click', () => { chatSettingsModal.classList.remove('active'); buttonClickSound.play(); });
            function goToLobby() { caseDetailView.classList.remove('visible'); setTimeout(() => { caseDetailView.classList.remove('active'); caseLobbyView.classList.add('active'); caseLobbyView.classList.add('visible'); CURRENT_CASE_ID = null; statusMessage.textContent = ''; }, 300); }
            function renderCaseDetails(caseId) { CURRENT_CASE_ID = caseId; const caseData = CASES[caseId]; const caseItems = ALL_ITEMS.filter(item => item.case === caseId); const totalRarity = caseItems.reduce((sum, item) => sum + item.rarity, 0); rollAreaContainer.innerHTML = ''; const singleRollArea = createRollAreaElement(caseId, false); rollAreaContainer.appendChild(singleRollArea); detailCaseName.textContent = caseData.name; detailOpenButtons.forEach(button => { const amount = parseInt(button.dataset.amount); const cost = amount * caseData.price; button.textContent = `Открыть ${amount === 1 ? '' : 'x'}${amount} (${cost} 💎)`; button.dataset.price = cost; button.dataset.caseId = caseId; }); chancesContent.innerHTML = caseItems.map(item => `<div class="chance-item ${item.class}"><span>${item.name}</span><span>${((item.rarity / totalRarity) * 100).toFixed(2)}%</span></div>`).join(''); itemsContent.innerHTML = caseItems.map(item => `<div class="content-item ${item.class}"><div class="item-icon">${item.icon}</div><div class="item-details"><div class="item-name">${item.name}</div><div class="item-sell">Продать: ${item.sell} 💎</div></div></div>`).join(''); document.querySelectorAll('.case-lobby-card').forEach(card => card.classList.add('fade-out')); setTimeout(() => { caseLobbyView.classList.remove('active', 'visible'); document.querySelectorAll('.case-lobby-card').forEach(card => card.classList.remove('fade-out')); caseDetailView.classList.add('active'); setTimeout(() => caseDetailView.classList.add('visible'), 50); }, 300); generateStrip(singleRollArea.querySelector('.item-strip'), getRandomItem(caseId)); }
            function createRollAreaElement(caseId, isSmall) { const rollArea = document.createElement('div'); rollArea.className = `roll-area ${isSmall ? 'small' : ''}`; const strip = document.createElement('div'); strip.className = 'item-strip'; rollArea.appendChild(strip); return rollArea; }
            function handleOpenCase(event) { const button = event.target; const caseId = button.dataset.caseId; const amount = parseInt(button.dataset.amount); const totalCost = parseInt(button.dataset.price); if (balance < totalCost) { showNotification(`Недостаточно средств!`, 'error'); return; } balance -= totalCost; updateBalance(); const isQuick = quickOpenToggle.checked; if (amount > 1 && !isQuick) { openAnimatedPack(caseId, amount); } else if (amount > 1 || isQuick) { openQuickPack(caseId, amount); } else { openSingleCase(caseId); } }
            function openSingleCase(caseId) { document.querySelectorAll('.open-case-btn').forEach(btn => btn.disabled = true); const winningItem = getRandomItem(caseId); if (quickOpenToggle.checked) { itemWinSound.play(); setTimeout(() => completeCaseOpening([winningItem]), 300); } else { caseOpenSound.play(); runAnimatedOpening(rollAreaContainer.querySelector('.roll-area'), winningItem); } }
            function openAnimatedPack(caseId, amount) { document.querySelectorAll('.open-case-btn').forEach(btn => btn.disabled = true); caseOpenSound.play(); rollAreaContainer.innerHTML = ''; const winningItems = []; const rollPromises = Array(amount).fill(null).map(() => { const winningItem = getRandomItem(caseId); winningItems.push(winningItem); const rollArea = createRollAreaElement(caseId, true); rollAreaContainer.appendChild(rollArea); return new Promise(resolve => runAnimatedOpening(rollArea, winningItem, true, resolve)); }); Promise.all(rollPromises).then(() => setTimeout(() => completeCaseOpening(winningItems), FINAL_PAUSE_DURATION)); }
            function openQuickPack(caseId, amount) { itemWinSound.play(); const winningItems = Array(amount).fill(null).map(() => getRandomItem(caseId)); setTimeout(() => completeCaseOpening(winningItems), 500); }
            function runAnimatedOpening(rollArea, winningItem, isSmall = false, resolve) { const itemStrip = rollArea.querySelector('.item-strip'); generateStrip(itemStrip, winningItem, isSmall); const itemSize = isSmall ? 60 : 110; const winCard = itemStrip.children[50]; const finalOffset = (rollArea.getBoundingClientRect().width / 2) - (winCard.offsetLeft + (itemSize / 2)) + (Math.random() * 20 - 10); itemStrip.style.transition = 'none'; itemStrip.style.transform = 'translateX(0px)'; setTimeout(() => { itemStrip.style.transition = `transform 9s cubic-bezier(0.1, 0.8, 0.3, 1)`; itemStrip.style.transform = `translateX(${finalOffset}px)`; }, 10); setTimeout(() => { if (resolve) resolve(); else completeCaseOpening([winningItem]); }, ANIMATION_DURATION); }
            function generateStrip(itemStrip, winningItem, isSmall = false) { itemStrip.innerHTML = ''; const stripItems = [...Array(50).fill(null).map(() => getRandomItem(CURRENT_CASE_ID)), winningItem, ...Array(50).fill(null).map(() => getRandomItem(CURRENT_CASE_ID))]; stripItems.forEach(item => itemStrip.appendChild(createItemCard(item, isSmall))); }
            function createItemCard(item, isSmall) { const card = document.createElement('div'); card.className = `item-card ${item.class}`; card.innerHTML = `<div class="item-card-icon">${item.icon}</div>${isSmall ? '' : item.name}`; return card; }
        });
    </script>
</body>
</html>
